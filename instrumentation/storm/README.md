# Background on storm instrumentation

This is lumigo instrumentation for the [storm](https://storm.apache.org/) library.

## We provide instrumentation for three key components within the Storm library:

* Storm Spouts 
* Storm Bolts 
* Storm `ExecutorTransfer` - This class is responsible for transferring tuples between Storm components and is utilized within the Storm `OutputCollector`.

Each of these components has a dedicated instrumentation class. 
An internal span is created for each execution of the spout or bolt, 
and for each tuple emitted with the OutputCollector to each receiving component.

## Otel conventions
For this instrumentation we used the following attributes:

1. `thread.name` - semantic convention default attribute
2. `messaging.system` - semantic convention default attribute
3. `messaging.message.id` - semantic convention default attribute
4. `messaging.destination.name` - semantic convention default attribute
5. `storm.type` - the type of the storm component spout / bolt
6. `storm.id` - the id of the storm topology
7. `storm.version` - the version of the storm library
8. `storm.tuple.values` - the value that emitted to each bolt
9. `source.component` - the previous component name (can be used to create trigger by behaviour)
10. `component.name` - the name of the component in the invocation override the otel_service_name property

## Building transactions

Transactions are constructed using the Storm `message.id`, which is added to the spout and bolt span attributes based on OpenTelemetry semantic conventions. 
This message ID is generated by the `ExecutorTransfer` when it sends the tuple to the next component, and it is included in the `ExecutorTransfer` span as well. 
Additionally, the `ExecutorTransfer` span is a child span of the spout/bolt that emitted the tuple. 
The hierarchy looks like this:
```
spout span
  |-> executor span (with message.id)
  
bolt span (with message.id)
```

## Possible improvements:

* Don't create Internal span for spout is which emitted no tuple. 
* Currently, internal spans are created for tuples emitted with the OutputCollector to Storm internal components (e.g., the acker). These spans are not displayed in the tree because they are not bolts or spouts and hence do not have spans.
* Infer component names from the thread name due to the lack of other identification methods.
